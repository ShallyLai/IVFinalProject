<!DOCTYPE html>
<meta charset="utf-8">

<!-- Load d3.js -->
<script src="https://d3js.org/d3.v6.js"></script>

<body>
	<div style="text-align:center;">
    <button onclick="Year(2017);" style="text-align:center;">2017</button>
    <button onclick="Year(2018);" style="text-align:center;">2018</button>
    <button onclick="Year(2019);" style="text-align:center;">2019</button>
    <button onclick="Year(2020);" style="text-align:center;">2020</button>
    <button onclick="Year(2021);" style="text-align:center;">2021</button>
    <button onclick="Year(2022);" style="text-align:center;">2022</button>
	</div>

  <!-- Create a div where the graph will take place -->
  <div id="my_dataviz" style="text-align:center;"></div>

	<script>

	// set the dimensions and margins of the graph
	const margin = {top: 10, right: 30, bottom: 20, left: 50},
	    width = 460 - margin.left - margin.right,
	    height = 400 - margin.top - margin.bottom;

	// append the svg object to the body of the page
	const svg = d3.select("#my_dataviz")
	  .append("svg")
	    .attr("width", width + margin.left + margin.right)
	    .attr("height", height + margin.top + margin.bottom)
	  .append("g")
	    .attr("transform", `translate(${margin.left},${margin.top})`);

  // Add X axis
  const x = d3.scaleBand()
      .range([0, width])
      .padding([0.2])
  const X_axis = svg.append("g")
    .attr("transform", `translate(0, ${height})`)

  // Add Y axis
  const y = d3.scaleLinear()
    .range([ height, 0 ]);
  const Y_axis = svg.append("g")  


	// Parse the Data
	function Year(EnterYear) {
		Promise.all([
      d3.json("https://raw.githubusercontent.com/holtzy/D3-graph-gallery/master/DATA/world.geojson"),
      d3.csv("https://raw.githubusercontent.com/ShallyLai/IVFinalProject/main/QS.csv")
    ]).then(function(initialize) {

			let dataGeo = initialize[0]; //world map
      let data = initialize[1]; //QS data
      var NowYear = EnterYear; //select year
      const ThisYear = [];
      //console.log(ThisYear)
      
      // Seperate data with year
      data.forEach(function(row) {
        //console.log(row)
        if (row.year == NowYear) {
          topush = {University: row.university, ResearchOutput: row.research_output, SFRatio: row.student_faculty_ratio * 100, InterStu:row.international_students * 100};
          ThisYear.push(topush);
        }
      });
      //console.log(data)
      console.log(ThisYear);

		  // List of subgroups is the header of ThisYear array  
		  const subgroups = Object.keys(ThisYear[0]).slice(1);
      //console.log(subgroups)

		  // List of groups = species here = value of the first column called group -> I show them on the X axis
      //console.log(ThisYear)
		  const groups = ThisYear.slice(0,2).map(d => d.University)

      x.domain(groups)
		  X_axis.call(d3.axisBottom(x).tickSizeOuter(0));

		  y.domain([0, 50])//
		  Y_axis.call(d3.axisLeft(y));

		  // color palette = one color per subgroup
		  const color = d3.scaleOrdinal()
		    .domain(subgroups)
		    .range(d3.schemeSet2);

		  //stack the data? --> stack per subgroup
		  const stackedData = d3.stack()
		    .keys(subgroups)
		    (ThisYear.slice(0,2))

      //console.log(ThisYear)
		  //console.log(stackedData)

      // ----------------
		  // Highlight a specific subgroup when hovered
		  // ----------------
      
		  // Show the bars
		  svg.append("g")
		    .selectAll("g")
		    // Enter in the stack data = loop key per key = group per group
		    .data(stackedData)
		    .join("g")
		      .attr("fill", d => color(d.key))
		      .attr("class", d => "myRect " + d.key ) // Add a class to each subgroup: their name
		      .selectAll("rect")
		      // enter a second time = loop subgroup per subgroup to add all rectangles
		      .data(d => d)
		      .join("rect")
		        .attr("x", function(d){
              return x(d.data.University)
            })
		        .attr("y", d => y(d[1]))
		        .attr("height", d => y(d[0]) - y(d[1]))
		        .attr("width",x.bandwidth())
		        .attr("stroke", "grey")
		        .on("mouseover", function (event,d) { // What happens when user hover a bar

		          // what subgroup are we hovering?
		          const subGroupName = d3.select(this.parentNode).datum().key

		          // Reduce opacity of all rect to 0.2
		           d3.selectAll(".myRect").style("opacity", 0.2)

		          // Highlight all rects of this subgroup with opacity 1. It is possible to select them since they have a specific class = their name.
		           d3.selectAll("."+subGroupName).style("opacity",1)
		        })
		        .on("mouseleave", function (event,d) { // When user do not hover anymore

		          // Back to normal opacity: 1
		          d3.selectAll(".myRect")
		          .style("opacity",1)
		      })

		})
	}
	</script>
</body>